<!doctype html>

<html>
    <head>
        <meta charset="UTF-8">
        <title>Scrabble du turfu</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <style>
            body {
                font-family: arial;
                width: 1000px;
                margin: auto;

            }

            .board-container {
                border: solid 5px black;
            }

            .board-table {
                border : solid 3px grey;
                width: 80%;
                margin: auto;
            }

            .board-table td {
                border: solid 2px blue;
                height: 45px;
                text-align: center;
                font-size: 200%;
            }

            .board-footer {
                text-align: center;
                border: solid black 5px;
            }

            .draw-list {
                /*width: 70%;*/
                margin: auto;
                text-align: center;
                display: inline-block;
            }

            .draw-element {
                border: solid 2px blue;
                width: 50px;
                height: 50px;
                margin: 10px 10px 5px 10px;
                display: inline-block;
                text-align: center;
                font-size: 200%;
            }

            .timer {
                padding: 15px;
                background-color: lightgray;
                display: inline-block;
            }

            .timer-label {
                font-weight: bold;
                /*font-size: 20px;*/
            }

            .timer-value {
                /*font-size: 25px;*/
            }

            .board-submit {
                display: inline-block;
                background: lightgray;
                padding: 15px;
                height: 100%;
            }

            .chat, .chat-prive {
                background-color: lightgray;
                position: fixed;
                width: 300px;
                height: 250px;
                border-radius: 5px;
                padding: 0 5px 10px 5px;
            }
            .chat {
                bottom : 0;
                left : 0;
            }

            .chat-prive {
                top: 50%;
                left: 0;
            }

            .chat-header:hover {
                cursor: grabbing;
            }

            .chat-header {
                width: 100%;
                /*height: 10%;*/
                display: block;
                margin: 5px 0 5px 5px;
                padding: 0;

            }

            .messages-container {
                display: block;
                overflow-y: scroll;
                height: 73%;
            }

            .chat form {
                display: block;
                /*border: solid 1px black;*/
                height: 30px;
                margin-top: 3px;
                text-align: center;
            }

            #messages {
                list-style-type: none;
                margin: 0;
                padding: 0;
                width: 100%;
            }

            .message {
                display: block;
                padding-left: 5px;
                /*border: solid 1px black;*/
            }

            .message-notice {
                font-style: italic;
            }

            .chat form button {
                /*position: absolute;
                right: 0;*/
                display: inline-block;
                width: 65px;
                height: 30px;
            }

            .chat form input {
              display: inline-block;
              width: calc(100% - 70px);
              height: 30px;
            }

            .chat li:nth-child(odd) { background: #eee; }


            .player-list {
                background: lightgray;
                position: fixed;
                top: 0;
                right: 0;
                padding: 0px 15px 15px 15px;
                border-radius: 5px;
                text-align: left;
            }

            .player-list ul {
                list-style-type: none;
                display: block;
                overflow-y: scroll;
                margin: 0;
                padding: 0;
                height: 150px;
            }

            .player-list li:nth-child(odd) { background: #eee; }

            .user {
                font-weight: bold;
            }

            .user:hover {
                text-decoration: underline;
                font-weight: bolder;
                cursor: pointer;
            }

            #connectionButton {
                margin-top: 15px;
                text-align: right;
            }

            #alert-placeholder {
                width: 600px;
                margin: auto;
            }

        </style>

    </head>
    <body onload="init();">

        <!-- Connexion -->
        <div class="modal fade" id="connectionModal" tabindex="-1" role="dialog" >
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel">Se connecter à un serveur</h4>
                    </div>
                    <form action="" id="connectionRequestForm">
                        <div class="modal-body">
                            <input placeholder="Adresse du serveur" id="serverAdress" name="serverAdress" type="text" required />
                            <input placeholder="Port" id="port" name="port" type="number" required />
                            <input placeholder="Pseudo" id="pseudo" name="pseudo" type="text" required />
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary" id="connectionButton">Se connecter</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="alert-placeholder">

            </div>
        </div>

        <!-- Board -->
        <div class="board-container" style="display: none">
            <table class="board-table" id="board-table">
            </table>

            <div class="board-footer">
                <div class="timer">
                    <p>
                    </span><span class="timer-label">Temps restant </span><br /><span id="timer-value">0</span> <span class="glyphicon glyphicon-time" aria-hidden="true">
                    </p>
                </div>
                <div class="draw-list">
                </div>
                <div class="board-submit">
                    <button>Soumettre plateau</button>
                </div>
            </div>
        </div>

        <!-- Chat (miaou) -->
        <div id="global-chat-window" class="chat">
            <h3 class="chat-header"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span> Chat</h3>
            <div class="messages-container">
                <ul id="messages">
                </ul>
            </div>
            <form id="global-chat" action="">
                <input placeholder="Écrits des bails ici." id="chat-input" autocomplete="off" />
                <button type="submit">Envoyer</button>
            </form>
        </div>

        <!-- Player list -->
        <div class="player-list">
            <h3>Liste des joueurs</h3>
            <ul id="player-list">

            </ul>
            <h4>Round : <span id="round-number">-</span></h4>
        </div>

        <!-- Scripts -->
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <script>
        jQuery.fn.exists = function(){return ($(this).length > 0);}


        const BOARD_SIZE = 15;
        const DRAW_SIZE = 7;

        const CONNECTION_ERROR_ALERT = '<div class="alert alert-info alert-dismissible" id="connexionFailureAlert" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>Échec de la connexion</strong></div>';

        function init() {
            $("#connectionModal").modal('show');

            generateBoard();
            generateDrawList();
            $('.board-container').show();
            $('.chat').draggable();
        }



        function generateBoard() {
            for (var i = 0; i < BOARD_SIZE; i++) {
                $('#board-table').append($('<tr>').attr('id', 'row-' + i));
                for (var j = 0; j < BOARD_SIZE; j++) {
                    $('#row-' + i).append($('<td>').attr('id', 'col-' + j).text('0'));
                }
            }
        }

        function generateDrawList() {
            for (var i = 0; i < DRAW_SIZE; i++) {
                $('.draw-list').append($('<span>').attr('class', 'draw-element').attr('id', 'draw-' + i));
            }
        }

        $(function () {
            var socket = io();
            var clientUsername;
            var connectedPlayers = [];
            var currentState;

            setInterval(function() {
                var timerValue = $('#timer-value').text();
                if (timerValue > 0)
                    timerValue--;

                $('#timer-value').text(timerValue);

            } ,1000);


            //Soummission du modal de connexion.
            $('#connectionRequestForm').submit(function(){
                $('#connectionButton').button('loading');
                clientUsername = $('#pseudo').val();
                socket.emit('serverConnectionRequest', $('#serverAdress').val(), $('#port').val(),$('#pseudo').val());

                return false;
            });


            $('#global-chat').submit(function() {
                if ($('#global-chat #chat-input').val() === "")
                    return false;

                var str = 'ENVOI/' + htmlEntities($('#global-chat #chat-input').val()) + "/\n";
                socket.emit('send', str);
                $('#global-chat #chat-input').val("");

                return false;
            });

            //Réponse à la soummission du modal de connxion par le socket.
            socket.on('connectionRequestAnswer', function(msg, code) {

                $('#connectionButton').button('reset');

                if (code === 0) {
                    initBoard();
                    connectedPlayers.push(clientUsername);
                    $('#connectionModal').modal('hide');

                } else {
                    $('#alert-placeholder').append(newErrorAlert(msg));
                }
            });

            socket.on('receive', function (data) {
                console.log("received : " + data);
                var args = data.split("/");
                console.log(args[0]);

                switch (args[0]) {
                    case 'RECEPTION':
                        receptionChat(args);
                        break;
                    case 'PRECEPTION':
                        receptionChatPrive(args);
                        break;
                    case 'BIENVENUE' :
                        bienvenue(args);
                        break;
                    case 'CONNECTE':
                        connecte(args);
                        break;
                    case 'DECONNEXION':
                        deconnexion(args);
                        break;
                    default:
                        console.log("Unhandled command : " + args[0]);
                }


            });


            function initBoard() {
                socket.emit('send', 'CONNEXION/' + clientUsername + "/\n");
            }

            function deconnexion(args) {
                $('#li-' + args[1]).remove();
                $('#mp-' + args[1]).remove();
                var index = connectedPlayers.indexOf(args[1]);
                if (index != undefined)
                    connectedPlayers.splice(index, index);

            }

            function connecte(args) {
                if (!connectedPlayers.includes(args[1])) {
                    $('#player-list').append($('<li id="li-' + args[1] + '">').append(getUserLink(args[1], true), ' 0'));
                    connectedPlayers.push(args[1]);
                }

            }

            function bienvenue(args) {
                var board = args[1];
                var draw = args[2];
                var scores = args[3];
                var state = args[4];
                var temps = args[5];

                currentState = state;
                $('#timer-value').text(temps);

                parseBoardState(board);
                parseDraw(draw);
                parseScores(scores);
            }

            function parseScores(scores) {
                var split = scores.split(/\*/g);
                $('#round-number').text(split[0]);
                for (i = 1; i < split.length; i+=2) {
                    $('#player-list').append($('<li id="li-' + split[i] + '" >').append(getUserLink(split[i], true), " " + split[i+1]));
                    if (split[i] != clientUsername)
                        connectedPlayers.push(split[i]);
                }

            }

            function parseDraw(draw) {
                for (i = 0; i < draw.length; i++) {
                    $('#draw-' + i).text(draw[i]);
                }
            }

            function parseBoardState(board) {
                for(i = 0; i < board.length; i++) {
                    c = board[i];
                    x = i % BOARD_SIZE;
                    y = (i / BOARD_SIZE) | 0;
                    if (c != '0') {
                        $('#row-' + y + " #col-" + x).text(c);
                    }
                }

            }

            function receptionChat(args) {
                var content = args[1];
                var author = args[2];
                $('#global-chat-window #messages').append(newChatMessage(author, content));
                $('#global-chat-window .messages-container').scrollTop($('.global-chat-window #messages').height());
            }

            function receptionChatPrive(args) {
                var content = args[1];
                var author = args[2];
                var windowId = '#mp-' + author;
                privateChatWindowVerif(author);
                $(windowId + ' #messages').append(newChatMessage(author, content));
                $(windowId + '.messages-container').scrollTop($(windowId + ' #messages').height());
            }

            function privateChatWindowVerif(author) {
                if (author == clientUsername) //Ne fait rien quand la cible est soit même.
                    return;
                if (!$('#mp-' + author).exists()) {
                    $('body').append(newPrivateChatWindow(author));
                }
            }

            function newChatMessage(user, content) {
                return $('<li class="message">').append(getUserLink(user), '<br />', content);
            }

            function newChatNotice(notice) {
                return $('<li class="message">').text(notice);
            }

            function getUserLink(username, removable) {
                if (removable == undefined)
                    removable = false;

                if (!removable) {
                    var result = $('<span class="user link-' + username + '">').text(username);
                } else {
                    var result = $('<span class="user link-' + username + ' removable">').text(username);
                }


                result.click(function() {
                    privateChatWindowVerif(username);
                });

                return result;
            }

            function newErrorAlert(notice) {
                var result;
                result = $('<div class="alert alert-info alert-dismissible" id="connexionFailureAlert" role="alert">');
                result.html('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>Échec de la connexion</strong> ' + notice);
                return result;
            }

            function htmlEntities(str) {
                return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/\//g, ':slash de gars qui veut foutre la merde:');
            }


            function newPrivateChatWindow(username) {
                var result = $('<div class="chat chat-prive" id="mp-' + username + '">');
                var header = $('<h3 class="chat-header">').text('/w ' + username);
                var mContainer = $('<div class="messages-container">');
                var messageList = $('<ul id="messages">');
                var form = $('<form action="">');
                var input = $('<input placeholder="Écrits des bails ici." id="chat-input" autocomplete="off" />');
                var btn = $('<button type="submit">').text('Envoyer');
                // var hidden = $('<input type="hidden" class="mp-username-v" value="' + username + '" />')
                form.append(input, btn);
                mContainer.append(messageList);
                result.append(header, mContainer, form);
                result.draggable();

                form.submit(function() {
                    if ($('#mp-' + username + ' #chat-input').val() === "")
                        return false;

                    var content = htmlEntities($('#mp-' + username + ' #chat-input').val());
                    var str = 'PENVOI/' + username + '/' + content + "/\n";
                    socket.emit('send', str);

                    $('#mp-' + username + ' #chat-input').val("");
                    $('#mp-' + username + ' #messages').append(newChatMessage(clientUsername, content));
                    $('#mp-' + username + ' .messages-container').scrollTop($('#mp-' + username + ' #messages').height());

                    return false;
                });

                return result;
            }

        });

        </script>
    </body>

</html>
